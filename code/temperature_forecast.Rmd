---
title: "Tempature Forecasting via Time Series Analysis"
author: "Xinyu Zhang"
date: "2022/2/20"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# time series forecasting
# library(rworldmap) #???? may not be used
library(TSA) # eacf
library("tseries") # adf.test
library(forecast) #auto.arima
library(dplyr)
library(fpp3) # time series models
library(feasts)
library(ggplot2)
library(fable)
```

 

```{r loadData}
cherry <- read.csv("../data/FinalizedData/FinalData/Kyoto.csv")
# cherry <- read.csv("../data/washingtondc.csv") %>% 
#   bind_rows(read.csv("../data/liestal.csv")) %>% 
#   bind_rows(read.csv("../data/kyoto.csv"))
str(cherry)
precip = cherry$PRCP
temp = cherry$TAVG
date = (as.Date(as.character(cherry$DATE)))
year = cherry$year
data = data.frame(precip, temp, date, year)
str(data)
head(data,2)
tail(data,2)
data_year = data %>% filter(year==2000)

```

```{r plot, fig.width=8, fig.height=3, warning=FALSE, message=FALSE}
par(mfrow=c(1,2))
#### Step 1: Preview
# Use ACF to identify the type of time series
acf(ts(data_year$temp), lag.max = 100, col = 'dark blue', bg = 'dark blue', 
    panel.first = grid(), main = 'ACF Plot of Adj. Price of AAPL', lwd=.01)
# Based on acf plot, we know that it is more likely to be an AR process
pacf(ts(data_year$temp), lag.max = 10, col = 'dark blue', bg = 'dark blue', 
     panel.first = grid(), main = 'PACF Plot of Adj. Price of AAPL')
# Since PACF damp out for AR(p) process when lag > p, we could guess that 
# it follows AR(p) process with p around 1 (or maybe 3? Or maybe ARMA)
adf.test(ts(data_year$temp))
# This means the trend has to be estimated

plot(x=data$date, y=ts(data$temp), main = "TS Plot of Temperature", type="l",
     col = 'dark blue', bg = 'dark blue',  panel.first = grid(), lty=1, ylab="Temperature", xlab="Day")

plot(x=data_year$date, y=ts(data_year$temp), main = "TS Plot of Temperature in 2020", type="l",
     col = 'dark blue', bg = 'dark blue',  panel.first = grid(), lty=1, ylab="Temperature", xlab="Day")

data_ts = as_tsibble(data, index=date)
data_ts %>%
  autoplot(temp, col="dark blue") +
  labs(x="Date", y = "Temperature", title = "Time series")

#'  Trend decomposition using additive model since the The additive 
#'  decomposition is the most appropriate if the magnitude of the 
#'  seasonal fluctuations, or the variation around the trend-cycle,
#'   does not vary with the level of the time series.

```



```{r}
#### Step 2 STL Decomposition
dcmp <- data_ts %>% 
  model(stl = STL(temp ~ trend(window=7), robust=TRUE)) %>%
  components() %>%
  select(-.model)
head(dcmp)

```

```{r}
#### Step 3 Forecasting
<<<<<<< HEAD
# h is forecasting horizon since the end of the data
h = 100
=======
h = 3740
>>>>>>> 31b9cf4048adbf85024dfa37c63ee6dd48ad9153
fcst = dcmp %>%
  model(SNAIVE(temp~lag("year"))) %>%
  forecast(h=h)

fcst %>% autoplot(dcmp) +
  labs(y = "Temperature",
       title = "TS Forecast of Temperature")

temprature_fcst = fcst$.mean


date.f = seq(from=tail(data$date,1), to=tail(data$date,1)+h, length.out=h)
data.forecast = data.frame(temp=temprature_fcst, date=date.f)
data_total = rbind(data[,c('temp','date')],data.forecast)
str(data.forecast)

write.csv(data.forecast,"../data/FinalizedData/FinalData/Liestal_temp_forecast_10_years.csv")

summary(data.forecast)

```

